name: Post Announcements to Slack

on:
  discussion:
    types: [created, edited]

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Check if announcement
        id: check
        run: |
          if [[ "${{ github.event.discussion.category.name }}" == "Announcements" ]]; then
            echo "âœ… Announcement detected"
            echo "is_announcement=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ Skipping - Category: ${{ github.event.discussion.category.name }}"
            echo "is_announcement=false" >> $GITHUB_OUTPUT
          fi

      - name: Post to Slack
        if: steps.check.outputs.is_announcement == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { discussion } = context.payload;
            const webhook = '${{ secrets.SLACK_DOGRAH_COMMUNITY_WEBHOOK_URL }}';
            
            if (!webhook) {
              core.setFailed('SLACK_DOGRAH_COMMUNITY_WEBHOOK_URL secret is not configured');
              return;
            }
            
            // Convert GitHub **bold** to Slack *bold*
            const body = discussion.body.replace(/\*\*([^*]+)\*\*/g, '*$1*');
            
            // Build Slack message
            const message = [
              'ðŸ“¢ *' + discussion.title + '*',
              '',
              body,
              '',
              '<' + discussion.html_url + '|View Discussion>'
            ].join('\n');
            
            // Send to Slack webhook
            try {
              const response = await fetch(webhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: message })
              });
              
              if (response.ok) {
                console.log('âœ… Successfully posted announcement to Slack');
              } else {
                core.setFailed(`Failed to post to Slack: ${response.status}`);
              }
            } catch (error) {
              core.setFailed(`Error posting to Slack: ${error.message}`);
            }