name: Post Announcements to Slack

on:
  discussion:
    types: [created, edited]

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Check if announcement
        id: check
        run: |
          if [[ "${{ github.event.discussion.category.slug }}" == "announcements" ]] || [[ "${{ github.event.discussion.category.name }}" == "Announcements" ]]; then
            echo "✅ Announcement detected in category: ${{ github.event.discussion.category.name }}"
            echo "is_announcement=true" >> $GITHUB_OUTPUT
          else
            echo "⏭️ Skipping - Not an announcement (category: ${{ github.event.discussion.category.name }})"
            echo "is_announcement=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Prepare and Post to Slack
        if: steps.check.outputs.is_announcement == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.discussion.title;
            let body = context.payload.discussion.body;
            const url = context.payload.discussion.html_url;
            const webhook = process.env.SLACK_WEBHOOK_URL;
            
            if (!webhook) {
              core.setFailed('SLACK_WEBHOOK_URL is not set');
              return;
            }
            
            // Convert GitHub markdown to Slack markdown
            body = body.replace(/\*\*([^*]+)\*\*/g, '*$1*');
            
            // Build message with real newlines
            const message = '📢 *' + title + '*\n\n' + body + '\n\n<' + url + '|View Discussion>';
            
            // Send to Slack
            const payload = { text: message };
            
            try {
              const response = await fetch(webhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              
              if (!response.ok) {
                core.setFailed(`Failed to send to Slack: ${response.status}`);
              } else {
                console.log('✅ Successfully sent announcement to Slack');
              }
            } catch (error) {
              core.setFailed(`Error sending to Slack: ${error.message}`);
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DOGRAH_COMMUNITY_WEBHOOK_URL }}